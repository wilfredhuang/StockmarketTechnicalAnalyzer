{% extends "layouts/layout.html" %}

{% block title %}Home - Flask Starter App{% endblock %}

{% block extra_css %}
<style>

    /* Style for the button when loading */
    .loading-btn {
        background-color: grey;
        color: white;
    }
    
    /* Spinner style */
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 2s linear infinite;
        display: inline-block;
        margin-right: 8px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    </style>

{% endblock %}


{% block content %}
<div class="container mt-4"></div>
    <div class="row mb-3">
        <div class="col-md-6">
            <p> Fetch Data </p>
        </div>
        <div class="col-md-6">
            <button id="fetch-data-btn" class="btn btn-success w-100">Fetch Data</button>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            <p> Process Data </p>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            <p> Select Strategy </p>
        </div>
        <div class="col-md-6">
            <select id="strategy-select" class="form-control">
                <option value="1">Strategy One: EMA Crossover</option>
                <option value="2">Strategy Two: EMA Crossover with RSI</option>
                <option value="3">Strategy Three: RSI with ADX</option>
                <option value="4">Strategy Four: Machine Learning with Indicators</option>
            </select>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
        </div>
        
        <div class="col-md-6">
            <button id="process-data-btn" class="btn btn-success w-100">Process Data</button>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            <p> Visualise Stock Price </p>
        </div>
        <div class="col-md-6">
            <button id="show-stock-price-btn" class="btn btn-success w-100">Visualise Stock Price</button>
        </div>
    </div>

    <!-- <img src="static/data/plot.png" alt="foobar" alt="Strategy Performance Graph"> -->
    <!-- <div class="row mb-3">
        <div class="col-md-6">
            <p> Read/Upload Data </p>
        </div>
        <div class="col-md-6">
            <button class="btn btn-success w-100">Read Data</button>
        </div>
    </div> -->

    <div class="show-graph">
    </div>
    <div class="show-stock-info">
        <p> Sample Text </p>
    </div>
    <div class="show-price-graph">
    </div>
    <!-- <div class="row">
        <div class="col-md-4">
            <button class="btn btn-primary w-100">Button 1</button>
        </div>
        <div class="col-md-4">
            <button class="btn btn-secondary w-100">Button 2</button>
        </div>
        <div class="col-md-4">
            <button class="btn btn-success w-100">Button 3</button>
        </div>
    </div> -->

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="home-tab" data-bs-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Home</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="profile-tab" data-bs-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Profile</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="contact-tab" data-bs-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="false">Contact</a>
        </li>
    </ul>
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">Home content goes here.</div>
        <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">Profile content goes here.</div>
        <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">Contact content goes here.</div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script> 
    document.addEventListener('DOMContentLoaded', function() {
        // Bootstrap Tab (JS Code for this may not be needed)
        const tabs = document.querySelectorAll(".nav-link");
            const tabContents = document.querySelectorAll(".tab-pane");

            tabs.forEach(tab => {
                tab.addEventListener("click", function(event) {
                    event.preventDefault(); // Prevent default anchor click behavior

                    // Remove active class from all tabs and hide all tab contents
                    tabs.forEach(t => t.classList.remove("active"));
                    tabContents.forEach(content => content.classList.remove("show", "active"));

                    // Add active class to the clicked tab and show corresponding content
                    this.classList.add("active");
                    const target = document.querySelector(this.getAttribute("href"));
                    target.classList.add("show", "active");
                });
            });
        //

        // Generic function template to send requests with fetch
        function sendRequest(url, method, data) {
            return fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    // Handle HTTP errors (e.g., 404, 500)
                    throw new Error('Network response was not ok');
                }
                const contentType = response.headers.get('content-type');
                // Check if response contains JSON and parse if so
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else if (response.status !== 204) {  // If not a 204 (No Content), return as text
                    return response.text();
                } else {
                    return null;  // Handle empty response (e.g., 204)
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }
        
        // Fetch Data Feature
        document.getElementById('fetch-data-btn').addEventListener('click', function() {
            const fetchDataBtn = document.getElementById('fetch-data-btn');
            
            // Disable the button and show loading state
            fetchDataBtn.disabled = true;
            fetchDataBtn.classList.add('loading-btn');
            
            // Change button text to 'Loading...' and add a spinner
            fetchDataBtn.innerHTML = `
                <div class="spinner"></div>
                Loading...
            `;
            
            sendRequest('/fetch-stock-data', 'POST', {})
            .then(data => {
                if (data) {
                    alert(data.message || data);  // Show the message if JSON is returned or text
                } else {
                    alert('No content received.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            })
            .finally(() => {
                // Re-enable the button and revert its text and styles
                fetchDataBtn.disabled = false;
                fetchDataBtn.classList.remove('loading-btn');
                fetchDataBtn.innerHTML = 'Fetch Data';
            });
    
            console.log("Clicked");
        });

        // Process Data Feature
        document.getElementById('process-data-btn').addEventListener('click', function() {
            const processDataBtn = document.getElementById('process-data-btn');
            const selectedStrategy = document.getElementById('strategy-select').value;


            // Disable the button and show loading state
            processDataBtn.disabled = true;
            processDataBtn.classList.add('loading-btn');
            
            // Change button text to 'Loading...' and add a spinner
            processDataBtn.innerHTML = `
                <div class="spinner"></div>
                Loading...
            `;
            
            sendRequest('/process-stock-data', 'POST', {strategy: selectedStrategy})
            .then(data => {
                if (data && data.image_url) {
                    //alert(data.message || data);  // Show the message if JSON is returned or text
                    // Update the 'show-graph' div with the new image

                    const graphDiv = document.querySelector('.show-graph');
                    graphDiv.innerHTML = `<img src="${data.image_url}" alt="Strategy Performance Graph">`;

                    const data_statistics = data.data_message;
                    console.log(`Data Statistics List is ${data_statistics}`)
                    data_statistics.forEach(stat => {
                        console.log("Item is ")
                        console.log(stat)
                        
                    });
                    console.log(`Each Item is ${data_statistics}`)
                    const stockMessageDiv = document.querySelector('.show-stock-info')
                    stockMessageDiv.innerHTML = ''; // Clear previous messages if necessary
                    data_statistics.forEach(stat => {
                        const p = document.createElement('p');
                        p.textContent = "Foobar"
                        stockMessageDiv.appendChild(p);
                      });

                    //stockMessageDiv.innerHTML = `<p> ${data.data_message} </p>`
                } else {
                    alert('No content received.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            })
            .finally(() => {
                // Re-enable the button and revert its text and styles
                processDataBtn.disabled = false;
                processDataBtn.classList.remove('loading-btn');
                processDataBtn.innerHTML = 'Process Data';
            });
    
            console.log("Clicked 2");
        });

               // Process Data Feature
               document.getElementById('show-stock-price-btn').addEventListener('click', function() {
                const showStockPriceBtn = document.getElementById('show-stock-price-btn');
                // Disable the button and show loading state
                showStockPriceBtn.disabled = true;
                showStockPriceBtn.classList.add('loading-btn');
                
                // Change button text to 'Loading...' and add a spinner
                showStockPriceBtn.innerHTML = `
                    <div class="spinner"></div>
                    Loading...
                `;
                
                sendRequest('/visualise-stock-price', 'POST', {})
                .then(data => {
                    if (data && data.image_url) {
                        //alert(data.message || data);  // Show the message if JSON is returned or text
                        // Update the 'show-graph' div with the new image
    
                        const priceGraphDiv = document.querySelector('.show-price-graph');
                        priceGraphDiv.innerHTML = `<img src="${data.image_url}" alt="Visualise Price Graph">`;    
                    } else {
                        alert('No content received.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                })
                .finally(() => {
                    // Re-enable the button and revert its text and styles
                    showStockPriceBtn.disabled = false;
                    showStockPriceBtn.classList.remove('loading-btn');
                    showStockPriceBtn.innerHTML = 'Visualise Stock Price';
                });
        
                console.log("Clicked 3");
            });
    });
    
</script>
{% endblock %}
